import os
import random
import requests
from lxml import html

import ocrfotomodule


def get_proxy():
    list_of_proxy=['185.156.178.92:26160', '193.19.119.126:26160', '195.62.52.146:26160', '185.158.112.190:26160', '185.158.114.17:26160', '185.158.114.192:26160', '185.158.115.210:26160', '185.158.115.242:26160', '193.233.149.129:26160', '193.233.149.130:26160', '193.233.149.131:26160', '193.233.149.132:26160', '193.233.149.133:26160', '', '193.233.149.134:26160', '', '193.233.149.139:26160', '193.233.149.183:26160', '193.233.149.200:26160', '193.233.149.202:26160', '194.116.163.24:26160', '194.116.163.25:26160', '194.116.163.30:26160', '194.116.163.31:26160', '194.116.163.32:26160', '194.116.163.33:26160', '194.116.163.34:26160', '194.116.163.39:26160', '194.116.163.40:26160', '194.116.163.41:26160', '194.116.163.42:26160', '194.116.163.43:26160', '194.116.163.44:26160', '193.233.149.123:26160', '193.233.149.124:26160', '83.217.10.102:26160', '213.159.202.77:26160', '185.134.120.63:26160', '83.217.10.112:26160', '213.159.202.81:26160', '185.248.102.48:26160', '185.248.102.97:26160', '185.248.102.208:26160', '213.159.204.127:26160', '83.217.8.184:26160', '185.239.50.81:26160', '91.221.109.213:26160', '91.221.109.222:26160', '91.221.109.223:26160', '91.221.109.214:26160', '91.221.109.232:26160', '91.221.108.239:26160', '91.221.108.240:26160', '91.221.108.232:26160', '185.189.132.132:26160', '185.189.132.130:26160', '185.189.132.69:26160', '185.189.132.68:26160', '85.143.189.73:26160', '85.143.189.51:26160', '85.143.189.48:26160', '85.143.188.68:26160', '85.143.188.67:26160', '85.143.188.42:26160', '85.143.188.35:26160', '85.143.171.106:26160', '85.143.171.105:26160', '85.143.171.6:26160', '85.143.171.4:26160', '85.143.170.5:26160', '85.143.170.3:26160', '85.143.169.101:26160', '85.143.169.100:26160', '85.143.169.35:26160', '85.143.169.34:26160', '85.143.169.33:26160', '85.143.169.32:26160', '185.189.132.136:26160', '185.189.132.135:26160', '194.113.107.15:26160', '194.113.107.16:26160', '194.113.107.17:26160', '194.113.107.18:26160', '194.113.107.25:26160', '194.113.107.26:26160', '194.113.107.27:26160', '194.113.107.28:26160', '194.113.107.7:26160', '194.113.107.8:26160', '194.113.107.9:26160', '185.254.189.1:26160', '185.254.189.9:26160', '185.254.189.10:26160', '185.254.189.11:26160', '185.254.189.12:26160', '185.254.189.18:26160', '185.254.189.19:26160', '185.254.189.20:26160', '185.254.189.21:26160', '185.254.189.22:26160', '185.254.189.23:26160', '185.254.189.30:26160', '185.254.189.31:26160', '185.254.189.32:26160', '185.254.189.33:26160', '185.254.189.41:26160', '185.254.189.42:26160', '185.254.189.43:26160', '185.254.189.44:26160', '185.254.189.51:26160', '185.254.189.52:26160', '185.254.189.53:26160', '185.254.189.54:26160', '185.254.189.55:26160', '185.254.189.62:26160', '185.254.189.63:26160', '195.209.51.121:26160', '195.209.51.5:26160', '195.209.51.55:26160', '195.209.51.58:26160', '195.209.51.60:26160', '195.209.51.89:26160', '195.209.51.94:26160', '195.209.51.8:26160', '195.209.51.96:26160', '195.209.51.99:26160', '195.209.51.101:26160', '195.209.51.145:26160', '195.209.51.19:26160', '195.209.51.171:26160', '195.209.51.196:26160', '195.209.51.198:26160', '195.209.51.215:26160', '195.209.51.223:26160', '195.209.51.31:26160', '195.209.51.226:26160', '195.209.51.228:26160', '195.209.51.230:26160', '195.209.51.243:26160', '195.209.51.245:26160', '195.209.51.250:26160', '195.209.51.33:26160', '195.209.51.252:26160', '195.209.51.35:26160', '92.255.99.43:26160', '92.255.99.48:26160', '92.255.99.50:26160', '92.255.99.19:26160', '92.255.99.118:26160', '92.255.99.22:26160', '92.255.99.24:26160', '185.118.166.125:26160', '185.118.166.135:26160', '185.118.166.138:26160', '185.156.178.168:26160', '185.156.178.169:26160', '185.156.178.170:26160', '185.156.178.171:26160', '185.156.178.172:26160', '185.156.178.173:26160', '185.156.178.174:26160', '185.156.178.175:26160', '95.182.120.69:26160', '45.8.158.61:26160', '45.8.158.62:26160', '45.8.158.63:26160', '188.119.65.92:26160', '194.156.120.201:26160', '193.233.72.247:26160', '91.200.150.119:26160', '91.200.150.129:26160', '91.200.150.194:26160', '91.200.150.195:26160', '82.202.194.181:26160', '188.93.20.210:26160', '45.8.124.40:26160', '95.213.253.11:26160', '45.8.124.24:26160', '193.33.132.157:26160', '193.33.132.158:26160', '91.230.210.246:26160', '185.25.60.240:26160', '91.230.210.241:26160', '45.137.190.13:26160', '45.137.189.40:26160', '45.137.189.39:26160', '45.137.190.12:26160', '45.137.190.7:26160', '45.137.190.6:26160', '45.137.190.5:26160', '80.87.201.117:26160', '80.87.201.142:26160', '80.87.201.131:26160', '80.87.201.133:26160', '80.87.201.140:26160', '185.173.179.200:26160', '185.173.176.36:26160', '185.173.179.221:26160', '185.173.179.212:26160', '185.173.179.213:26160', '185.173.179.220:26160', '93.88.77.60:26160', '93.88.77.59:26160', '93.88.77.58:26160', '93.88.77.83:26160', '194.67.223.251:26160', '194.67.208.36:26160', '194.67.208.233:26160', '5.8.76.195:26160', '5.8.76.194:26160', '195.20.197.78:26160', '94.229.22.58:26160', '185.66.219.2:26160', '94.229.21.173:26160', '94.229.21.174:26160', '89.223.100.31:26160', '89.223.100.74:26160', '89.223.100.124:26160', '89.223.100.115:26160', '89.223.100.128:26160', '89.223.100.38:26160', '89.223.100.82:26160', '89.223.100.117:26160', '89.223.100.88:26160', '45.134.27.58:26160', '45.134.27.198:26160', '45.134.27.52:26160', '45.134.27.184:26160', '45.134.27.180:26160', '194.1.237.118:26160', '194.1.237.53:26160', '193.9.60.199:26160', '194.1.239.224:26160', '194.1.239.196:26160', '193.32.188.90:26160', '193.32.188.101:26160', '193.32.188.230:26160', '193.32.188.113:26160', '193.32.188.252:26160', '5.45.83.138:26160', '91.224.22.59:26160', '91.224.23.230:26160', '91.224.23.231:26160', '91.224.23.232:26160', '91.224.22.155:26160', '91.224.23.239:26160', '91.224.23.240:26160', '91.224.23.241:26160', '91.224.23.242:26160', '91.224.22.158:26160', '91.224.22.159:26160', '91.224.22.161:26160', '91.224.22.162:26160', '185.4.65.121:26160', '185.4.66.211:26160', '185.4.67.135:26160', '185.4.64.165:26160', '185.4.65.13:26160', '185.4.65.143:26160', '185.4.67.83:26160', '185.4.67.96:26160', '37.252.0.105:26160', '5.45.80.250:26160', '5.45.81.45:26160', '45.139.186.111:26160', '45.139.187.20:26160', '81.177.3.90:26160', '217.107.217.52:26160', '81.177.22.136:26160', '81.177.23.26:26160', '81.177.23.219:26160', '195.158.224.238:26160', '195.158.225.51:26160', '185.66.13.33:26160', '185.80.148.192:26160', '185.80.149.217:26160', '185.80.149.252:26160', '185.255.178.98:26160', '185.255.178.144:26160', '185.255.178.168:26160', '185.255.178.183:26160', '185.255.178.204:26160', '45.15.253.8:26160', '45.15.253.61:26160', '45.15.253.64:26160', '45.15.253.95:26160', '45.15.253.111:26160', '212.22.70.241:26160', '45.140.167.215:26160', '45.140.167.214:26160', '45.140.167.213:26160', '45.140.167.208:26160', '45.140.167.205:26160', '45.140.167.204:26160', '212.22.70.248:26160', '93.189.41.23:26160', '93.189.40.32:26160', '93.189.43.88:26160', '93.189.43.89:26160', '93.189.46.124:26160', '93.189.46.126:26160', '93.189.47.25:26160']
    login_password=str(os.environ.get("PROXY"))
    proxy=login_password+'@'+list_of_proxy[random.randint(0,len(list_of_proxy)-1)]
    return proxy

def get_tags(photo_url):
    yandex_search = "https://yandex.ru/images/search?source=collections&rpt=imageview&rdrnd="+str(random.randint(100000, 999999))+"&redircnt="+str(random.randint(1000000000, 9999999999))+".1&url="+photo_url
    headers = {
        'device-memory': '8',
        'dpr': '1',
        'viewport-width': '1920',
        'rtt': '50',
        'downlink': '2.25',
        'ect': '4g',
        'Upgrade-Insecure-Requests': '1',
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36',
        'Sec-Fetch-Dest': 'document',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9',
        'Sec-Fetch-Site': 'none',
        'Sec-Fetch-Mode': 'navigate'
        }
    proxies = { 'https' : 'https://'+get_proxy() }
    html_url = requests.get(yandex_search, proxies=proxies, headers=headers)
    tree_html = html.fromstring(html_url.text.encode('UTF-8'))
    tags_tree = tree_html.xpath('//a[contains(@class, "tags__tag")]')
    tags = [i.text for i in tags_tree]
    if tags == []:
        proxies = { 'https' : 'https://'+get_proxy() }
        html_url = requests.get(yandex_search, proxies=proxies, headers=headers)
        tree_html = html.fromstring(html_url.text.encode('UTF-8'))
        tags_tree = tree_html.xpath('//a[contains(@class, "tags__tag")]')
        tags = [i.text for i in tags_tree]

    ocr_text = tree_html.xpath('//div[contains(@class, "serp-block__head")]')
    ocr = [i.text for i in ocr_text]
    text = ''
    if "Текст на картинке" in ocr:
        text = ocrfotomodule.get_ocr(photo_url)
    return tags, text


if __name__ == '__main__':
    photo_list=['https://sun1-16.userapi.com/c857324/v857324287/133ac9/beiTE06vygI.jpg', 'https://sun9-41.userapi.com/c858328/v858328236/1a8a0f/4EzXDLpO4Pk.jpg', 'https://sun1-99.userapi.com/c857216/v857216892/130399/a5kzTNEzlAY.jpg', 'https://sun1-17.userapi.com/c206524/v206524878/bdcb8/uqQXe4sCgks.jpg', 'https://sun1-86.userapi.com/c857228/v857228716/133cde/nTk8AeE4-r8.jpg']
    for i in photo_list:
        result = get_tags(i)
        print(result)
